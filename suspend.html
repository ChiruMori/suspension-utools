<!DOCTYPE html>
<html>
<style type="text/css">
    body {
        margin: 0px;
        width: 100%;
        height: 100;
        -webkit-user-select: none;
        user-select: none;
        overflow: hidden;
        overflow-x: hidden;
        overflow-y: hidden;
        opacity: 1;
    }

    .hover-area {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    .hover-area:hover {
        opacity: 0.8;
    }

    .main {
        width: 100%;
        height: auto;
        border-radius: 6px;
        overflow: hidden !important;
    }
    
    .drag-area {
        -webkit-app-region: drag;
        cursor: move;
    }

</style>

<body class="hover-area">
    <div>
        <img class="main"/>
        <iframe class="main"></iframe>
    </div>
</body>

<script type="application/javascript">

    // local storage 获取要显示的东西
    const eleKey = window.location.hash.substring(1);
    const resource = localStorage[eleKey];
    const filePath = localStorage[eleKey + "_file"];
    localStorage.removeItem(eleKey);
    localStorage.removeItem(eleKey + "_file");
    // 全局变量常量
    const minWidth = 100;
    let lock = false;
    let picResource = filePath && !filePath.endsWith('.html') ? filePath : '';
    window.rotateX = 0;
    window.rotateY = 0;
    // 页面组件及初始化
    const img = document.querySelector("img");
    const iframe = document.querySelector("iframe");
    if (!picResource) {
        iframe.src = filePath;
        img.style.display = 'none';
    } else {
        img.src = resource;
        iframe.style.display = 'none';
    }
    // 绑定监听
    bindKeyboardListener();
    bindMouseWheelListener();
    bindMouseDrag();

    // 旋转窗口
    function rotate(degree) {
        if (lock) {
            return;
        }
        lock = true;
        // 获得窗口长宽
        let { width, height } = picResource ? img : iframe;
        // 计算改变后窗口位置和大小
        let R = Math.sqrt(width * width + height * height);
        let xOffset = (R - width) / 2;
        let yOffset = (R - height) / 2;

        if (picResource) {
            img.src = rotateImage(degree);
            img.onload = () => {
                window.moveBounds(yOffset - xOffset, xOffset - yOffset, height, width);
                lock = false;
            }
        } else {
            window.moveBounds(yOffset - xOffset, xOffset - yOffset, height, width);
            lock = false;
        }
    }

    /**
     * 绑定键盘按键事件
     */
    function bindKeyboardListener() {
        let keyCounter = {
            lastKey: undefined,
            key: undefined,
            count: 3,
            time: 0
        }
        let dowingKey = {};
        document.addEventListener("keyup", event => {
            delete dowingKey[event.key]
        })
        document.addEventListener("keydown", event => {
            // console.log(event.key);
            //长按操作将加速
            if (keyCounter.key === event.key && new Date().getTime() - keyCounter.time < 200) {
                keyCounter.count++
            } else {
                keyCounter.key = event.key
                keyCounter.count = 3;
                keyCounter.time = 0;
            }
            keyCounter.time = new Date().getTime();
            switch (event.key) {
                case "s":
                case "S":
                    if (dowingKey["Control"] || dowingKey["Meta"]) {
                        document.body.className = ""
                        //等待透明关闭，再保存当前图片
                        setTimeout(() => window.saveNowImage(), 100)
                    } else if (!picResource) {
                        iframe.width = defaultWidth;
                        iframe.height = defaultHeight;
                    }
                    break
                case "c":
                case "C":
                    if (dowingKey["Control"] || dowingKey["Meta"]) {
                        document.body.className = ""
                        //等待透明关闭，再拷贝当前图片
                        setTimeout(() => window.copyNowImage(), 100)
                    }
                    break
                case "q":
                case "Q":
                    document.body.className = ""
                    //等待透明关闭，再去编辑图片
                    setTimeout(() => window.toEdit(), 100)
                    break;
                case "Escape":
                    window.close();
                    break;
                case "ArrowUp":
                    window.moveBounds(0, -keyCounter.count / 3);
                    break;
                case "ArrowDown":
                    window.moveBounds(0, keyCounter.count / 3);
                    break;
                case "ArrowLeft":
                    window.moveBounds(-keyCounter.count / 3, 0);
                    break;
                case "ArrowRight":
                    window.moveBounds(keyCounter.count / 3, 0);
                    break;
                case "+":
                case "=":
                    window.resize(keyCounter.count / 2, img.height / img.width);
                    break;
                case "-":
                case "_":
                    if (img.width > minWidth) {
                        window.resize(0 - keyCounter.count / 2, img.height / img.width);
                    }
                    break;
                //旋转相关
                case "【":
                case "[": {
                    rotate(-90);
                    break;
                }
                case "】":
                case "]": {
                    rotate(90);
                    break;
                }
                //左右反转
                case "Home":
                case "End":
                    window.rotateY += 180;
                    window.document.body.style.webkitTransform = `rotateX(${window.rotateX}deg) rotateY(${window.rotateY}deg)`
                    break;
                //上下反转
                case "PageUp":
                case "PageDown":
                    window.rotateX -= 180;
                    window.document.body.style.webkitTransform = `rotateX(${window.rotateX}deg) rotateY(${window.rotateY}deg)`
                    break;
            }
            dowingKey[event.key] = true
        });
    }
    
    /**
     * 绑定鼠标滚轮事件
     */
    function bindMouseWheelListener() {
        document.body.addEventListener('mousewheel', (e) => {
            let ele = picResource ? img : iframe;
            let delta = -e.deltaY;
            if (delta < 0 && ele.width <= minWidth) {
                return false;
            }
            window.resize(delta / 50, ele.height / ele.width);
            return false;
        });
    }

    /**
     * 绑定鼠标拖动事件，点击后3s内可以拖拽，3s后恢复鼠标事件功能
     */
    function bindMouseDrag() {
        document.body.onclick = function() {
            const dragAreaClass = 'drag-area';
            document.body.classList.add(dragAreaClass);
            setTimeout(() => {
                document.body.classList.remove(dragAreaClass);
            }, 3000);
        }
    }

    // 重画图片
    function rotateImage(degree) {
        degree = degree % 360;
        let img = document.querySelector("img");
        let tmpImg = new Image()
        tmpImg.src = img.src;
        let canvas = document.createElement('canvas');
        let cContext = canvas.getContext('2d');
        let height = tmpImg.height;
        let width = tmpImg.width;
        canvas.width = height;
        canvas.height = width;
        cContext.translate(canvas.width / 2, canvas.height / 2);
        cContext.rotate(degree * Math.PI / 180);
        cContext.drawImage(tmpImg, -width / 2, -height / 2);
        return canvas.toDataURL();
    }

</script>

</html>